<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>DDD on tomato blog</title><link>https://yuhi-sa.github.io/tags/ddd/</link><description>Recent content in DDD on tomato blog</description><generator>Hugo</generator><language>ja</language><lastBuildDate>Wed, 23 Jul 2025 21:10:46 +0900</lastBuildDate><atom:link href="https://yuhi-sa.github.io/tags/ddd/index.xml" rel="self" type="application/rss+xml"/><item><title>DDDの集約設計：不変条件がトランザクションより優先される理由</title><link>https://yuhi-sa.github.io/posts/20240606_ddd/1/</link><pubDate>Thu, 06 Jun 2024 09:10:00 +0900</pubDate><guid>https://yuhi-sa.github.io/posts/20240606_ddd/1/</guid><description>&lt;p&gt;&lt;code&gt;DDD&lt;/code&gt;(ドメイン駆動設計)において、集約はシステムの重要な部分です。多くの場合、集約について議論するときにトランザクションが強調されますが、実際には「不変条件」の方が重要です。&lt;/p&gt;
&lt;h2 id="不変条件とは"&gt;不変条件とは&lt;/h2&gt;
&lt;p&gt;不変条件とは、オブジェクトが常に満たすべき条件や性質のことです。これは「変更不可能なオブジェクト（&lt;code&gt;immutable&lt;/code&gt;）」とは異なり、オブジェクトの状態が変わる際にも必ず守られるべきルール(&lt;code&gt;invariant&lt;/code&gt;)です。
例えば、銀行口座の残高が負にならないことなどです。&lt;/p&gt;
&lt;h2 id="集約と不変条件"&gt;集約と不変条件&lt;/h2&gt;
&lt;p&gt;集約は、この不変条件を保つように設計されるべきです。&lt;code&gt;TypeScript&lt;/code&gt;を使う場合、&lt;code&gt;zod&lt;/code&gt;の&lt;code&gt;refine&lt;/code&gt;を使用して不変条件をチェックできます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;
&lt;table style="border-spacing:0;padding:0;margin:0;border:0;"&gt;&lt;tr&gt;&lt;td style="vertical-align:top;padding:0;margin:0;border:0;"&gt;
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 1
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 2
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 3
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 4
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 5
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 6
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 7
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 8
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt; 9
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt;10
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt;11
&lt;/span&gt;&lt;span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%"&gt;
&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-.ts" data-lang=".ts"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="font-weight:bold"&gt;import&lt;/span&gt; { z } &lt;span style="font-weight:bold"&gt;from&lt;/span&gt; &lt;span style="color:#b84"&gt;&amp;#39;zod&amp;#39;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#998;font-style:italic"&gt;// BankAccountのスキーマを定義
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#998;font-style:italic"&gt;&lt;/span&gt;&lt;span style="font-weight:bold"&gt;const&lt;/span&gt; BankAccountSchema &lt;span style="font-weight:bold"&gt;=&lt;/span&gt; z.&lt;span style="color:#458;font-weight:bold"&gt;object&lt;/span&gt;({
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; id: &lt;span style="color:#458;font-weight:bold"&gt;z.string&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; balance: &lt;span style="color:#458;font-weight:bold"&gt;z.number&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}).refine(data &lt;span style="font-weight:bold"&gt;=&amp;gt;&lt;/span&gt; data.balance &lt;span style="font-weight:bold"&gt;&amp;gt;=&lt;/span&gt; &lt;span style="color:#099"&gt;0&lt;/span&gt;, {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; message&lt;span style="font-weight:bold"&gt;:&lt;/span&gt; &lt;span style="color:#b84"&gt;&amp;#34;Balance must be non-negative&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;});
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#998;font-style:italic"&gt;// BankAccount型を定義
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#998;font-style:italic"&gt;&lt;/span&gt;&lt;span style="font-weight:bold"&gt;type&lt;/span&gt; BankAccount &lt;span style="font-weight:bold"&gt;=&lt;/span&gt; z.&lt;span style="font-weight:bold"&gt;infer&lt;/span&gt;&amp;lt;&lt;span style="color:#000080"&gt;typeof&lt;/span&gt; &lt;span style="color:#008080"&gt;BankAccountSchema&lt;/span&gt;&amp;gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id="トランザクションと不変条件"&gt;トランザクションと不変条件&lt;/h2&gt;
&lt;p&gt;不変条件を常に保つことが約束された集約単位でトランザクションを行えば、不変条件は常に保たれる。&lt;/p&gt;</description></item></channel></rss>