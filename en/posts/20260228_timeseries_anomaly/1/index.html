<!doctype html><html lang=en dir=ltr data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#e74c3c"><meta name=format-detection content="telephone=no"><meta name=robots content="index,follow"><meta name=description content="A comprehensive guide to time-series anomaly detection methods, from statistical approaches (moving average + standard deviation) to Kalman filter …"><meta name=keywords content="anomaly detection,time series,Kalman filter,moving average,Python,innovation sequence,outlier detection,signal processing"><meta name=author content="yuhi-sa"><link rel=canonical href=https://yuhi-sa.github.io/en/posts/20260228_timeseries_anomaly/1/><meta property="og:type" content="article"><meta property="og:title" content="Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python"><meta property="og:description" content="A comprehensive guide to time-series anomaly detection methods, from statistical approaches (moving average + standard deviation) to Kalman filter …"><meta property="og:url" content="https://yuhi-sa.github.io/en/posts/20260228_timeseries_anomaly/1/"><meta property="og:site_name" content="tomato blog"><meta property="og:locale" content="en"><meta property="og:image" content="https://yuhi-sa.github.io/ogp.jpeg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="article:published_time" content="2026-02-28T11:00:00+09:00"><meta property="article:modified_time" content="2026-02-28T19:16:58+09:00"><meta property="article:tag" content="Machine Learning"><meta property="article:tag" content="Filtering"><meta property="article:tag" content="Python"><meta property="article:tag" content="Signal Processing"><meta property="article:section" content="posts"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python"><meta name=twitter:description content="A comprehensive guide to time-series anomaly detection methods, from statistical approaches (moving average + standard deviation) to Kalman filter …"><meta name=twitter:image content="https://yuhi-sa.github.io/ogp.jpeg"><title>Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python | tomato blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preconnect href=https://cdn.jsdelivr.net crossorigin><link rel=preconnect href=https://pagead2.googlesyndication.com crossorigin><link rel=dns-prefetch href=https://pagead2.googlesyndication.com><link rel=icon href=https://yuhi-sa.github.io/favicon.ico><link rel=alternate hreflang=ja href=https://yuhi-sa.github.io/posts/20260228_timeseries_anomaly/1/><link rel=alternate hreflang=en href=https://yuhi-sa.github.io/en/posts/20260228_timeseries_anomaly/1/><link rel=alternate hreflang=x-default href=https://yuhi-sa.github.io/en/posts/20260228_timeseries_anomaly/1/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python","description":"A comprehensive guide to time-series anomaly detection methods, from statistical approaches (moving average \u002b standard deviation) to Kalman filter innovation-based detection, with Python implementations and comparisons.","author":{"@type":"Person","name":"yuhi-sa","url":"https:\/\/yuhi-sa.github.io\/"},"publisher":{"@type":"Organization","name":"tomato blog","logo":{"@type":"ImageObject","url":"https:\/\/yuhi-sa.github.io\/ogp.jpeg"},"url":"https:\/\/yuhi-sa.github.io\/"},"datePublished":"2026-02-28T11:00:00\u002b09:00","dateModified":"2026-02-28T19:16:58\u002b09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yuhi-sa.github.io\/en\/posts\/20260228_timeseries_anomaly\/1\/"},"url":"https:\/\/yuhi-sa.github.io\/en\/posts\/20260228_timeseries_anomaly\/1\/","wordCount":2431,"keywords":["Machine Learning","Filtering","Python","Signal Processing"],"articleSection":"Posts","inLanguage":"en","timeRequired":"PT12M"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"tomato blog","item":"https:\/\/yuhi-sa.github.io\/en\/"},{"@type":"ListItem","position":2,"name":"Posts","item":"https:\/\/yuhi-sa.github.io\/en\/posts\/"},{"@type":"ListItem","position":3,"name":"Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python"}]}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin=anonymous referrerpolicy=no-referrer><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH crossorigin=anonymous><link rel=stylesheet href=/css/variables.min.72a177faa7b12de55dcc39c4ab6b6392116718d5e2735dab0214511354ecb973.css integrity="sha256-cqF3+qexLeVdzDnEq2tjkhFnGNXic12rAhRRE1TsuXM=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.403a82b29e94ee6e7a39204b5082cdf8b4966cfb44115390da7d8867a5006acd.css integrity="sha256-QDqCsp6U7m56OSBLUILN+LSWbPtEEVOQ2n2IZ6UAas0=" crossorigin=anonymous><link rel=stylesheet href=/css/syntax.min.e379066489e20d5433ca35ac1f468fd9e8859705a62d77a79bb7379ac3613848.css integrity="sha256-43kGZIniDVQzyjWsH0aP2eiFlwWmLXenm7c3msNhOEg=" crossorigin=anonymous><style>body{font-family:-apple-system,BlinkMacSystemFont,inter,segoe ui,Roboto,sans-serif;line-height:1.5;color:#000;background:#fff}[data-theme=dark] body{color:#fff;background:#000}.container{max-width:768px;margin:0 auto;padding:0 1rem}</style><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js integrity=sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz crossorigin=anonymous defer></script><script src=/js/dark-mode.min.3e457dc8346f064bee795e6f9b73e1516dcd059e750c521fe4b445f9ea9a7821.js integrity="sha256-PkV9yDRvBkvueV5vm3PhUW3NBZ51DFIf5LRF+eqaeCE=" defer></script><script>window.addEventListener("load",function(){const e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-LN6QP6VVM3",document.head.appendChild(e),e.onload=function(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","G-LN6QP6VVM3")}})</script><script>window.MathJax={tex:{inlineMath:[["\\(","\\)"]],displayMath:[["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}}</script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js id=mathjax-script async></script></head><body itemscope itemtype=https://schema.org/WebPage class=theme-tomatohugo><a href=#main-content class="skip-link sr-only sr-only-focusable" aria-label="Skip to main content">Skip to main content</a><header role=banner class=site-header><nav class="navbar navbar-expand-lg navbar-light bg-light" role=navigation aria-label="Main navigation"><div class=container><a class=navbar-brand href=https://yuhi-sa.github.io/ aria-label="Return to tomato blog homepage">tomato blog
</a><button class="navbar-toggler d-lg-none" type=button data-bs-toggle=collapse data-bs-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation menu">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNav><ul class="navbar-nav ms-auto" role=menubar><li class=nav-item role=none><a class=nav-link href=https://yuhi-sa.github.io/en/ role=menuitem aria-label="Navigate to Blog">Blog</a></li><li class=nav-item role=none><a class=nav-link href=https://yuhi-sa.github.io/en/tags/ role=menuitem aria-label="Navigate to Tags">Tags</a></li><li class=nav-item role=none><a class=nav-link href=https://yuhi-sa.github.io/en/posts/about/ role=menuitem aria-label="Navigate to About">About</a></li><li class=nav-item role=none><a class=nav-link href=https://yuhi-sa.github.io/en/posts/privacy_policy/ role=menuitem aria-label="Navigate to Privacy policy">Privacy policy</a></li><li class=nav-item role=none><button id=darkModeToggle class="nav-link btn btn-link border-0" type=button role=menuitem aria-label="Toggle dark mode" title="Switch between light and dark themes">
<i class="fas fa-moon" id=darkModeIcon aria-hidden=true></i>
<span class="d-lg-none ms-2">ダークモード</span></button></li></ul></div></div></nav><script data-ad-client=ca-pub-9558545098866170 async crossorigin=anonymous src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></header><main id=main-content role=main class=site-main aria-label="Main content"><div class="container mt-4"><div class="row justify-content-center"><div class=col-lg-8><article itemscope itemtype=https://schema.org/Article><header class=article-header><h1 itemprop=headline>Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python</h1><p class="lead article-description" itemprop=description>A comprehensive guide to time-series anomaly detection methods, from statistical approaches (moving average + standard deviation) to Kalman filter innovation-based detection, with Python implementations and comparisons.</p><div class=article-meta><time datetime=2026-02-28T11:00:00+09:00 itemprop=datePublished><i class="far fa-calendar-alt me-1" aria-hidden=true></i>
February 28, 2026
</time><time datetime=2026-02-28T19:16:58+09:00 itemprop=dateModified class=ms-3><i class="far fa-edit me-1" aria-hidden=true></i>
Updated
February 28, 2026
</time><span aria-label="Reading time" class=ms-3><i class="far fa-clock me-1" aria-hidden=true></i>
12 min read</span></div><div class=article-tags role=group aria-label="Article tags"><a href=/en/tags/machine-learning/ class="badge badge-custom text-decoration-none me-1" rel=tag itemprop=keywords>Machine Learning
</a><a href=/en/tags/filtering/ class="badge badge-custom text-decoration-none me-1" rel=tag itemprop=keywords>Filtering
</a><a href=/en/tags/python/ class="badge badge-custom text-decoration-none me-1" rel=tag itemprop=keywords>Python
</a><a href=/en/tags/signal-processing/ class="badge badge-custom text-decoration-none me-1" rel=tag itemprop=keywords>Signal Processing</a></div></header><div class=article-content itemprop=articleBody><h2 id=introduction>Introduction</h2><p>Anomaly detection in time-series data is an essential technique across many domains: IoT sensor fault detection, manufacturing quality control, financial fraud detection, and server monitoring. Detecting anomalies early can prevent costly failures and system outages.</p><p>This article systematically covers three anomaly detection methods for time-series data, with Python implementations and performance comparisons.</p><ol><li><strong>Moving Average + Standard Deviation (Bollinger Band method)</strong> &ndash; the simplest statistical approach</li><li><strong>Exponential Moving Average (EMA) + Residual Analysis</strong> &ndash; an adaptive smoothing approach</li><li><strong>Kalman Filter Innovation Sequence</strong> &ndash; a state-space model-based approach</li></ol><p>We progress from simple to model-based methods, making the strengths and trade-offs of each approach clear.</p><h2 id=types-of-anomalies>Types of Anomalies</h2><p>Anomalies in time-series data fall into three broad categories.</p><h3 id=point-anomaly>Point Anomaly</h3><p>A single data point deviates significantly from the rest of the data. Examples include sensor spikes and communication errors producing outlier values.</p><h3 id=contextual-anomaly>Contextual Anomaly</h3><p>The value itself falls within the normal range, but is abnormal given its context (time of day, season, etc.). For example, observing summer-level temperatures in winter.</p><h3 id=collective-anomaly>Collective Anomaly</h3><p>Individual data points appear normal, but a sequence of points together forms an anomalous pattern. An example would be an unusual rhythm appearing briefly in an ECG signal.</p><p>This article focuses on <strong>point anomaly detection</strong>, the most fundamental and practically useful category.</p><h2 id=test-data-generation>Test Data Generation</h2><p>To compare the three methods fairly, we generate a common test dataset. The base signal includes a sine wave and a linear trend, with the following injected anomalies:</p><ul><li><strong>Point anomalies</strong> (spikes): sudden value jumps at known indices</li><li><strong>Level shift</strong>: a step change in the baseline at a known index</li><li><strong>Gradual drift</strong>: a slowly increasing offset starting at a known index</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>300</span>  <span class=c1># Number of data points</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Base signal: sine wave + linear trend + noise</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base_signal</span> <span class=o>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>*</span> <span class=n>t</span> <span class=o>/</span> <span class=mi>100</span><span class=p>)</span> <span class=o>+</span> <span class=mf>0.02</span> <span class=o>*</span> <span class=n>t</span>
</span></span><span class=line><span class=cl><span class=n>noise</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>base_signal</span> <span class=o>+</span> <span class=n>noise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ground truth labels (0: normal, 1: anomaly)</span>
</span></span><span class=line><span class=cl><span class=n>labels</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Inject point anomalies (spikes)</span>
</span></span><span class=line><span class=cl><span class=n>spike_indices</span> <span class=o>=</span> <span class=p>[</span><span class=mi>50</span><span class=p>,</span> <span class=mi>120</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=mi>250</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>spike_indices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>+=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>labels</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Inject level shift (index 160 to 180)</span>
</span></span><span class=line><span class=cl><span class=n>shift_start</span><span class=p>,</span> <span class=n>shift_end</span> <span class=o>=</span> <span class=mi>160</span><span class=p>,</span> <span class=mi>180</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=n>shift_start</span><span class=p>:</span><span class=n>shift_end</span><span class=p>]</span> <span class=o>+=</span> <span class=mf>6.0</span>
</span></span><span class=line><span class=cl><span class=n>labels</span><span class=p>[</span><span class=n>shift_start</span><span class=p>:</span><span class=n>shift_end</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Inject gradual drift (index 220 to 240)</span>
</span></span><span class=line><span class=cl><span class=n>drift_start</span><span class=p>,</span> <span class=n>drift_end</span> <span class=o>=</span> <span class=mi>220</span><span class=p>,</span> <span class=mi>240</span>
</span></span><span class=line><span class=cl><span class=n>drift</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>drift_end</span> <span class=o>-</span> <span class=n>drift_start</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=n>drift_start</span><span class=p>:</span><span class=n>drift_end</span><span class=p>]</span> <span class=o>+=</span> <span class=n>drift</span>
</span></span><span class=line><span class=cl><span class=n>labels</span><span class=p>[</span><span class=n>drift_start</span><span class=p>:</span><span class=n>drift_end</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Visualization</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>6</span><span class=p>),</span> <span class=n>sharex</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=s2>&#34;b-&#34;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Observed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>base_signal</span><span class=p>,</span> <span class=s2>&#34;g--&#34;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;True signal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;red&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Anomaly (ground truth)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s2>&#34;Value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&#34;Test Data with Injected Anomalies&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s2>&#34;upper left&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>stem</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>labels</span><span class=p>,</span> <span class=n>linefmt</span><span class=o>=</span><span class=s2>&#34;r-&#34;</span><span class=p>,</span> <span class=n>markerfmt</span><span class=o>=</span><span class=s2>&#34;ro&#34;</span><span class=p>,</span> <span class=n>basefmt</span><span class=o>=</span><span class=s2>&#34;k-&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s2>&#34;Label&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s2>&#34;Time step&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&#34;Ground Truth Labels&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_yticks</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><p>This dataset contains point anomalies (4 spikes), a level shift (20 steps), and gradual drift (20 steps), enabling a multi-faceted evaluation of each method&rsquo;s detection capabilities.</p><h2 id=method-1-moving-average--standard-deviation-bollinger-band-method>Method 1: Moving Average + Standard Deviation (Bollinger Band Method)</h2><h3 id=concept>Concept</h3><p>The simplest anomaly detection approach computes local mean and standard deviation from past data, and flags points that fall outside that range. This is known as the Bollinger Band method in finance.</p><h3 id=mathematics>Mathematics</h3><p>From the most recent \(W\) data points, we compute the rolling mean and rolling standard deviation.</p>\[
\mu_t = \frac{1}{W}\sum_{i=t-W+1}^{t} x_i \tag{1}
\]\[
\sigma_t = \sqrt{\frac{1}{W}\sum_{i=t-W+1}^{t} (x_i - \mu_t)^2} \tag{2}
\]<p>The anomaly criterion is as follows.</p>\[
\text{anomaly if } |x_t - \mu_t| > k\sigma_t \tag{3}
\]<p>Here \(k\) is the threshold multiplier. Under a normal distribution assumption, \(k=3\) keeps approximately 99.7% of data within the normal range.</p><h3 id=parameters>Parameters</h3><ul><li><strong>Window size \(W\)</strong>: larger values produce stronger smoothing but slower response to changes</li><li><strong>Threshold multiplier \(k\)</strong>: larger values reduce false positives but increase false negatives</li></ul><h3 id=python-implementation>Python Implementation</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>detect_sma</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mf>3.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Anomaly detection using moving average + standard deviation&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>anomalies</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>scores</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>window</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>segment</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=n>window</span><span class=p>:</span><span class=n>t</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>mu</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>segment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sigma</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>segment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>-</span> <span class=n>mu</span><span class=p>)</span> <span class=o>/</span> <span class=n>sigma</span> <span class=k>if</span> <span class=n>sigma</span> <span class=o>&gt;</span> <span class=mf>1e-10</span> <span class=k>else</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>scores</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>k</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>anomalies</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>anomalies</span><span class=p>,</span> <span class=n>scores</span>
</span></span></code></pre></div><h3 id=characteristics>Characteristics</h3><ul><li><strong>Pros</strong>: Simple to implement and interpret. Parameter meanings are clear</li><li><strong>Cons</strong>: Fixed window cannot adapt to signal dynamics. Detection is delayed by half the window size. Sustained changes like level shifts get absorbed into the window and become undetectable</li></ul><p>For more on moving average filters, see <a href=https://yuhi-sa.github.io/en/posts/20260225_moving_average/1/>Moving Average Filter Types and Comparison</a>.</p><h2 id=method-2-exponential-moving-average-ema--residual-analysis>Method 2: Exponential Moving Average (EMA) + Residual Analysis</h2><h3 id=concept-1>Concept</h3><p>EMA provides adaptive smoothing that places greater weight on recent data. By analyzing the residuals between EMA predictions and actual observations, we can detect anomalies.</p><h3 id=mathematics-1>Mathematics</h3><p>The EMA prediction is computed by the following recursive formula.</p>\[
\hat{x}_t = \alpha x_t + (1-\alpha)\hat{x}_{t-1} \tag{4}
\]<p>The residual (prediction error) between the previous prediction and the current observation serves as the anomaly score.</p>\[
e_t = x_t - \hat{x}_{t-1} \tag{5}
\]<p>We normalize by the exponentially weighted moving standard deviation (EWMSTD) and flag anomalies.</p>\[
\text{anomaly if } |e_t| > k \cdot \text{EWMSTD}_t \tag{6}
\]<p>Where EWMSTD is the exponentially weighted moving standard deviation of the residuals.</p>\[
\text{EWMSTD}_t^2 = \alpha \cdot e_t^2 + (1-\alpha) \cdot \text{EWMSTD}_{t-1}^2 \tag{7}
\]<h3 id=python-implementation-1>Python Implementation</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>detect_ema</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mf>3.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Anomaly detection using EMA + residual analysis&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>anomalies</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>scores</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ema_val</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ema_var</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Compute residual</span>
</span></span><span class=line><span class=cl>        <span class=n>residual</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>-</span> <span class=n>ema_val</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ema_var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Anomaly score (evaluate with variance BEFORE incorporating current residual)</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>residual</span><span class=p>)</span> <span class=o>/</span> <span class=n>ema_std</span> <span class=k>if</span> <span class=n>ema_std</span> <span class=o>&gt;</span> <span class=mf>1e-10</span> <span class=k>else</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>scores</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>k</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>anomalies</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Update exponentially weighted moving variance (after score computation)</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_var</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>residual</span> <span class=o>**</span> <span class=mi>2</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>ema_var</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Update EMA</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_val</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>data</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>ema_val</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>anomalies</span><span class=p>,</span> <span class=n>scores</span>
</span></span></code></pre></div><h3 id=characteristics-1>Characteristics</h3><ul><li><strong>Pros</strong>: Faster response than SMA due to heavier weighting on recent data. Memory efficient at \(O(1)\)</li><li><strong>Cons</strong>: Does not explicitly model signal dynamics (trends, etc.). Choosing \(\alpha\) requires experience</li></ul><p>For a deeper dive into EMA&rsquo;s mathematical properties, see <a href=https://yuhi-sa.github.io/en/posts/20220206_ema/1/>Frequency Characteristics of the EMA Filter</a>.</p><h2 id=method-3-kalman-filter-anomaly-detection>Method 3: Kalman Filter Anomaly Detection</h2><p>This method models time-series data as a state-space system and leverages the statistical properties of the Kalman filter&rsquo;s innovation sequence to detect anomalies. The key advantage over statistical methods is the ability to explicitly model signal dynamics (level and trend).</p><h3 id=state-space-model-setup>State-Space Model Setup</h3><p>We describe the time series using two states: &ldquo;level&rdquo; and &ldquo;trend (slope).&rdquo;</p><p>For the state vector \(\mathbf{x}_k = [\ell_k, b_k]^T\) (level, trend), we define the following state-space model.</p><p><strong>State transition matrix:</strong></p>\[
A = \begin{bmatrix} 1 & 1 \\\ 0 & 1 \end{bmatrix} \tag{8}
\]<p>This models &ldquo;level increases by the trend, and trend remains constant.&rdquo;</p><p><strong>Observation matrix:</strong></p>\[
H = \begin{bmatrix} 1 & 0 \end{bmatrix} \tag{9}
\]<p>Only the level component is observed.</p><p>For the foundational theory, see <a href=https://yuhi-sa.github.io/en/posts/20260224_kalman_filter/1/>Kalman Filter Theory and Python Implementation</a>.</p><h3 id=innovation-sequence>Innovation Sequence</h3><p>The <strong>innovation</strong> (observation residual) from the Kalman filter&rsquo;s prediction step is the difference between the predicted and actual observation.</p>\[
\mathbf{y}_k = \mathbf{z}_k - H\hat{\mathbf{x}}_{k|k-1} \tag{10}
\]<p>Under normal operating conditions, the innovation follows this distribution:</p>\[
\mathbf{y}_k \sim \mathcal{N}(\mathbf{0}, S_k) \tag{11}
\]<p>Where \(S_k\) is the innovation covariance matrix.</p>\[
S_k = HP_{k|k-1}H^T + R \tag{12}
\]<p>As long as the model correctly captures the signal dynamics, the innovation is a zero-mean white noise sequence. When an anomaly occurs, the statistical properties of the innovation change, which we can use for anomaly detection.</p><h3 id=normalized-innovation-squared-nis>Normalized Innovation Squared (NIS)</h3><p>We define the <strong>Normalized Innovation Squared</strong> (NIS) by normalizing the innovation with its covariance.</p>\[
\nu_k = \mathbf{y}_k^T S_k^{-1} \mathbf{y}_k \tag{13}
\]<p>Under normal conditions, NIS follows a chi-squared distribution with \(m\) degrees of freedom (where \(m\) is the observation dimension).</p>\[
\nu_k \sim \chi^2(m) \tag{14}
\]<p>For our 1D observation case (\(m=1\)), the anomaly criterion becomes:</p>\[
\text{anomaly if } \nu_k > \chi^2_{1-\alpha}(1) \tag{15}
\]<p>At significance level \(\alpha = 0.01\), the threshold is \(\chi^2_{0.99}(1) \approx 6.63\).</p><h3 id=python-implementation-2>Python Implementation</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy.stats</span> <span class=kn>import</span> <span class=n>chi2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>detect_kalman</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>q</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span> <span class=n>r</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>sig_level</span><span class=o>=</span><span class=mf>0.01</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Anomaly detection using Kalman filter innovation sequence&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>anomalies</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>nis_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>innovations</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>filtered</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># State-space model definition (level + trend)</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                  <span class=p>[</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>    <span class=n>H</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>    <span class=n>Q</span> <span class=o>=</span> <span class=n>q</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>R</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=n>r</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Initialization</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mf>0.0</span><span class=p>])</span>  <span class=c1># [level, trend]</span>
</span></span><span class=line><span class=cl>    <span class=n>P</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diag</span><span class=p>([</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Chi-squared threshold (1 degree of freedom, significance level sig_level)</span>
</span></span><span class=line><span class=cl>    <span class=n>threshold</span> <span class=o>=</span> <span class=n>chi2</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>sig_level</span><span class=p>,</span> <span class=n>df</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Prediction step</span>
</span></span><span class=line><span class=cl>        <span class=n>x_pred</span> <span class=o>=</span> <span class=n>A</span> <span class=o>@</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>        <span class=n>P_pred</span> <span class=o>=</span> <span class=n>A</span> <span class=o>@</span> <span class=n>P</span> <span class=o>@</span> <span class=n>A</span><span class=o>.</span><span class=n>T</span> <span class=o>+</span> <span class=n>Q</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Innovation</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>-</span> <span class=n>H</span> <span class=o>@</span> <span class=n>x_pred</span>
</span></span><span class=line><span class=cl>        <span class=n>S</span> <span class=o>=</span> <span class=n>H</span> <span class=o>@</span> <span class=n>P_pred</span> <span class=o>@</span> <span class=n>H</span><span class=o>.</span><span class=n>T</span> <span class=o>+</span> <span class=n>R</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># NIS (Normalized Innovation Squared)</span>
</span></span><span class=line><span class=cl>        <span class=n>S_inv</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=o>/</span> <span class=n>S</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>nis</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>y</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>S_inv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>nis_values</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>nis</span>
</span></span><span class=line><span class=cl>        <span class=n>innovations</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>y</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Anomaly decision</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>nis</span> <span class=o>&gt;</span> <span class=n>threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>anomalies</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Update step (Kalman gain)</span>
</span></span><span class=line><span class=cl>        <span class=n>K</span> <span class=o>=</span> <span class=n>P_pred</span> <span class=o>@</span> <span class=n>H</span><span class=o>.</span><span class=n>T</span> <span class=o>*</span> <span class=n>S_inv</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>x_pred</span> <span class=o>+</span> <span class=n>K</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span> <span class=o>*</span> <span class=n>y</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>P</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>-</span> <span class=n>K</span> <span class=o>@</span> <span class=n>H</span><span class=p>)</span> <span class=o>@</span> <span class=n>P_pred</span>
</span></span><span class=line><span class=cl>        <span class=n>filtered</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>filtered</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>anomalies</span><span class=p>,</span> <span class=n>nis_values</span><span class=p>,</span> <span class=n>innovations</span><span class=p>,</span> <span class=n>filtered</span>
</span></span></code></pre></div><p>When an anomaly is detected, the state is still updated normally via the Kalman gain. A more robust implementation could reject anomalous observations and maintain the state using the prediction alone.</p><h2 id=comparison-experiment>Comparison Experiment</h2><p>We apply all three methods to the same test data and compare their detection performance.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>precision_score</span><span class=p>,</span> <span class=n>recall_score</span><span class=p>,</span> <span class=n>f1_score</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Apply each method</span>
</span></span><span class=line><span class=cl><span class=n>sma_anomalies</span><span class=p>,</span> <span class=n>sma_scores</span> <span class=o>=</span> <span class=n>detect_sma</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mf>3.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ema_anomalies</span><span class=p>,</span> <span class=n>ema_scores</span> <span class=o>=</span> <span class=n>detect_ema</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mf>3.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>kf_anomalies</span><span class=p>,</span> <span class=n>kf_nis</span><span class=p>,</span> <span class=n>kf_innov</span><span class=p>,</span> <span class=n>kf_filtered</span> <span class=o>=</span> <span class=n>detect_kalman</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>q</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span> <span class=n>r</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Compute evaluation metrics (exclude first 30 steps for SMA window)</span>
</span></span><span class=line><span class=cl><span class=n>eval_start</span> <span class=o>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=n>y_true</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=n>eval_start</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>preds</span> <span class=ow>in</span> <span class=p>[(</span><span class=s2>&#34;SMA+σ&#34;</span><span class=p>,</span> <span class=n>sma_anomalies</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                     <span class=p>(</span><span class=s2>&#34;EMA+σ&#34;</span><span class=p>,</span> <span class=n>ema_anomalies</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                     <span class=p>(</span><span class=s2>&#34;Kalman NIS&#34;</span><span class=p>,</span> <span class=n>kf_anomalies</span><span class=p>)]:</span>
</span></span><span class=line><span class=cl>    <span class=n>y_pred</span> <span class=o>=</span> <span class=n>preds</span><span class=p>[</span><span class=n>eval_start</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>precision_score</span><span class=p>(</span><span class=n>y_true</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>,</span> <span class=n>zero_division</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>recall_score</span><span class=p>(</span><span class=n>y_true</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>,</span> <span class=n>zero_division</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>f1</span> <span class=o>=</span> <span class=n>f1_score</span><span class=p>(</span><span class=n>y_true</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>,</span> <span class=n>zero_division</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;Precision&#34;</span><span class=p>:</span> <span class=n>p</span><span class=p>,</span> <span class=s2>&#34;Recall&#34;</span><span class=p>:</span> <span class=n>r</span><span class=p>,</span> <span class=s2>&#34;F1&#34;</span><span class=p>:</span> <span class=n>f1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Display results table</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;Method&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Precision&#39;</span><span class=si>:</span><span class=s2>&gt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Recall&#39;</span><span class=si>:</span><span class=s2>&gt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;F1 Score&#39;</span><span class=si>:</span><span class=s2>&gt;10</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>metrics</span> <span class=ow>in</span> <span class=n>results</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>name</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;Precision&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;10.3f</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;Recall&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;10.3f</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;F1&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;10.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=visualization-of-detection-results>Visualization of Detection Results</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>14</span><span class=p>),</span> <span class=n>sharex</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Original data</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=s2>&#34;b-&#34;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Observed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;red&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>25</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Ground truth&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s2>&#34;Value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&#34;Test Data&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s2>&#34;upper left&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SMA + σ</span>
</span></span><span class=line><span class=cl><span class=n>sma_det</span> <span class=o>=</span> <span class=n>sma_anomalies</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=s2>&#34;b-&#34;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>sma_det</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>sma_det</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;orange&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s2>&#34;x&#34;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Detected&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;red&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Ground truth&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s2>&#34;Value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&#34;SMA + σ (W=30, k=3)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s2>&#34;upper left&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># EMA + σ</span>
</span></span><span class=line><span class=cl><span class=n>ema_det</span> <span class=o>=</span> <span class=n>ema_anomalies</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=s2>&#34;b-&#34;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>ema_det</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>ema_det</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;orange&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s2>&#34;x&#34;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Detected&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;red&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Ground truth&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s2>&#34;Value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&#34;EMA + σ (α=0.3, k=3)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s2>&#34;upper left&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kalman NIS</span>
</span></span><span class=line><span class=cl><span class=n>kf_det</span> <span class=o>=</span> <span class=n>kf_anomalies</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=s2>&#34;b-&#34;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>kf_det</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>kf_det</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;orange&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s2>&#34;x&#34;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Detected&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=n>labels</span> <span class=o>==</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=s2>&#34;red&#34;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>zorder</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s2>&#34;Ground truth&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s2>&#34;Value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&#34;Kalman Filter NIS (q=0.01, r=1.0, α=0.01)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s2>&#34;Time step&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s2>&#34;upper left&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=discussion>Discussion</h3><p>Running the code above prints each method&rsquo;s Precision, Recall, and F1 Score. The test data is reproducible via <code>np.random.seed(42)</code>, so you can verify the exact numbers. The results will vary with parameter choices. Below are the qualitative trends.</p><p>Each method exhibits distinct detection characteristics:</p><ul><li><strong>SMA + σ</strong>: Effective for spike-type point anomalies, but the window-size delay means it only catches the leading edge of level shifts. Gradual changes like drift get absorbed into the window and are classified as normal</li><li><strong>EMA + σ</strong>: Responds faster than SMA, improving level shift detection. However, without explicit trend modeling, it remains vulnerable to trend changes</li><li><strong>Kalman NIS</strong>: By modeling trend as a state variable, it can detect the onset of level shifts and drift. However, once the model adapts to the new signal dynamics, it classifies the post-adaptation data as normal rather than flagging the entire anomalous region. Note that our ground truth labels the entire level-shift region as anomalous, but in a change-point detection framing, only the transition point would be labeled anomalous. This definitional difference makes the Kalman filter&rsquo;s recall appear lower than it would under a change-point evaluation</li></ul><h2 id=choosing-the-right-method>Choosing the Right Method</h2><p>A practical guide for selecting the appropriate method.</p><table><thead><tr><th style=text-align:left>Criterion</th><th style=text-align:left>SMA + σ</th><th style=text-align:left>EMA + σ</th><th style=text-align:left>Kalman NIS</th></tr></thead><tbody><tr><td style=text-align:left>Implementation complexity</td><td style=text-align:left>Low</td><td style=text-align:left>Low</td><td style=text-align:left>Medium</td></tr><tr><td style=text-align:left>Parameter sensitivity</td><td style=text-align:left>Moderate</td><td style=text-align:left>Moderate</td><td style=text-align:left>Moderate (depends on Q, R)</td></tr><tr><td style=text-align:left>Model assumptions</td><td style=text-align:left>None</td><td style=text-align:left>None</td><td style=text-align:left>Linear-Gaussian</td></tr><tr><td style=text-align:left>Handles trends</td><td style=text-align:left>No</td><td style=text-align:left>Partially</td><td style=text-align:left>Yes</td></tr><tr><td style=text-align:left>Detection latency</td><td style=text-align:left>\(W/2\) steps</td><td style=text-align:left>1 step</td><td style=text-align:left>1 step</td></tr><tr><td style=text-align:left>Memory usage</td><td style=text-align:left>\(O(W)\)</td><td style=text-align:left>\(O(1)\)</td><td style=text-align:left>\(O(d^2)\) (\(d\): state dim)</td></tr><tr><td style=text-align:left>Best for</td><td style=text-align:left>Simple threshold monitoring</td><td style=text-align:left>Streaming data</td><td style=text-align:left>Model-based systems</td></tr></tbody></table><p><strong>Selection guidelines:</strong></p><ul><li><strong>Start with</strong>: SMA + σ. It is simple, interpretable, and performs well enough in many situations</li><li><strong>When real-time performance matters</strong>: EMA + σ. It has 1-step latency and \(O(1)\) computational cost</li><li><strong>When trends or level changes are present</strong>: Kalman filter NIS. It can explicitly model signal dynamics for more accurate anomaly detection</li></ul><h2 id=summary>Summary</h2><p>This article covered three anomaly detection methods for time-series data, with Python implementations and comparisons.</p><ul><li><strong>Moving average + standard deviation</strong> is the simplest and most intuitive method, effective for spike-type point anomalies</li><li><strong>EMA + residual analysis</strong> provides adaptive smoothing with less detection latency than SMA, well suited for streaming applications</li><li><strong>Kalman filter NIS</strong> is a state-space model-based method that can detect anomalies involving trend changes</li><li>Method selection depends on data characteristics and requirements (real-time needs, presence of trends, implementation constraints)</li><li>In practice, combining multiple methods can improve detection reliability</li></ul><h2 id=related-articles>Related Articles</h2><ul><li><a href=https://yuhi-sa.github.io/en/posts/20260224_kalman_filter/1/>Kalman Filter Theory and Python Implementation</a> - Covers the foundational theory and implementation underlying the Kalman filter method used in this article.</li><li><a href=https://yuhi-sa.github.io/en/posts/20260224_ekf/1/>Extended Kalman Filter (EKF) Theory and Python Implementation</a> - Extends the Kalman filter for nonlinear time-series data.</li><li><a href=https://yuhi-sa.github.io/en/posts/20220206_ema/1/>Frequency Characteristics of the EMA Filter</a> - Detailed analysis of EMA&rsquo;s mathematical properties and frequency response.</li><li><a href=https://yuhi-sa.github.io/en/posts/20260225_moving_average/1/>Moving Average Filter Types and Comparison</a> - Comparison of SMA, WMA, and EMA characteristics with Python implementations.</li><li><a href=https://yuhi-sa.github.io/en/posts/20260226_arima/1/>ARIMA Time-Series Forecasting in Python</a> - Covers ARIMA, a representative time-series modeling method.</li><li><a href=https://yuhi-sa.github.io/en/posts/20200901_filter/1/>Fundamentals of Filtering Methods in Signal Processing</a> - An overview of various filtering methods including the Kalman filter.</li><li><a href=https://yuhi-sa.github.io/en/posts/20260223_rts_smoother/1/>RTS Smoother Theory and Python Implementation</a> - A smoothing method useful for offline anomaly detection that uses data from all time steps.</li></ul><h2 id=references>References</h2><ul><li>Basseville, M., & Nikiforov, I. V. (1993). <em>Detection of Abrupt Changes: Theory and Application</em>. Prentice Hall.</li><li>Bar-Shalom, Y., Li, X. R., & Kirubarajan, T. (2004). <em>Estimation with Applications to Tracking and Navigation</em>. Wiley.</li><li>SciPy Documentation: <a href=https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.chi2.html>scipy.stats.chi2</a></li></ul></div><div class="ad-slot in-content my-3"><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-9558545098866170></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class=article-footer></footer><meta itemprop=wordCount content="2431"><meta itemprop=url content="https://yuhi-sa.github.io/en/posts/20260228_timeseries_anomaly/1/"></article><nav class="post-nav mt-5" aria-label="Post navigation"><a href=/en/posts/20260228_fft_window_psd/1/ class="post-nav__item post-nav__item--prev"><span class="post-nav__label text-muted"><i class="fas fa-arrow-left me-1" aria-hidden=true></i>前の記事
</span><span class=post-nav__title>Window Functions and Power Spectral Density (PSD): Theory and Python Implementation</span>
</a><a href=/en/posts/20260228_notch_filter/1/ class="post-nav__item post-nav__item--next"><span class="post-nav__label text-muted">次の記事<i class="fas fa-arrow-right ms-1" aria-hidden=true></i>
</span><span class=post-nav__title>Notch Filter Design and Python Implementation: Removing Power Line Noise</span></a></nav><section class="related-posts mt-5" aria-label="Related posts"><h2 class=related-posts__title>関連記事</h2><div class=related-posts__grid><article class=related-posts__item><h3 class=related-posts__item-title><a href=/en/posts/20260223_rts_smoother/1/>Kalman Smoother (RTS Smoother): Theory and Python Implementation</a></h3><div class=card-meta><time datetime=2026-02-23>February 23, 2026</time></div></article><article class=related-posts__item><h3 class=related-posts__item-title><a href=/en/posts/20260228_notch_filter/1/>Notch Filter Design and Python Implementation: Removing Power Line Noise</a></h3><div class=card-meta><time datetime=2026-02-28>February 28, 2026</time></div></article><article class=related-posts__item><h3 class=related-posts__item-title><a href=/en/posts/20260226_wiener_filter/1/>Wiener Filter: Optimal Linear Filtering Theory and Python Implementation</a></h3><div class=card-meta><time datetime=2026-02-26>February 26, 2026</time></div></article></div></section><nav class="article-navigation mt-4" aria-label="Article navigation"><a href=/en/posts/ class="btn btn-outline-secondary btn-sm mb-3"><i class="fas fa-arrow-left me-1" aria-hidden=true></i>
Back to posts</a><nav aria-label="Breadcrumb navigation" class=breadcrumb-nav role=navigation><ol class=breadcrumb itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumb-item itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/en/ itemprop=item aria-label="Navigate to homepage"><i class="fas fa-home" aria-hidden=true></i>
<span itemprop=name>tomato blog</span>
</a><meta itemprop=position content="1"></li><li class=breadcrumb-item itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=https://yuhi-sa.github.io/en/ itemprop=item aria-label="Navigate to tomato blog"><span itemprop=name>tomato blog</span>
</a><meta itemprop=position content="2"></li><li class=breadcrumb-item itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=https://yuhi-sa.github.io/en/posts/ itemprop=item aria-label="Navigate to Posts"><span itemprop=name>Posts</span>
</a><meta itemprop=position content="3"></li><li class="breadcrumb-item active" aria-current=page itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><span itemprop=name>Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python</span>
<meta itemprop=position content="4"></li></ol></nav></nav></div></div></div></main><footer role=contentinfo class=site-footer><div class="container pt-4 pb-3" style="border-top:2px solid var(--accent,#e54d2e)"><div class="row justify-content-center"><div class="col-md-8 text-center"><p class="copyright-text text-muted mb-2">&copy; 2026 yuhi-sa. All rights reserved.</p><p class="theme-attribution text-muted small mt-2 mb-0">Powered by
<a href=https://gohugo.io/ target=_blank rel=noopener class=text-decoration-none>Hugo</a>
with
<a href=https://github.com/yuhi-sa/tomatohugo target=_blank rel=noopener class=text-decoration-none>TomatoHugo</a></p></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js integrity=sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz crossorigin=anonymous defer></script><script src=/js/dark-mode.min.3e457dc8346f064bee795e6f9b73e1516dcd059e750c521fe4b445f9ea9a7821.js integrity="sha256-PkV9yDRvBkvueV5vm3PhUW3NBZ51DFIf5LRF+eqaeCE=" defer></script><script>window.addEventListener("load",function(){const e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-LN6QP6VVM3",document.head.appendChild(e),e.onload=function(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","G-LN6QP6VVM3")}})</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","name":"Time-Series Anomaly Detection: From Statistical Methods to Kalman Filter in Python","url":"https:\/\/yuhi-sa.github.io\/en\/posts\/20260228_timeseries_anomaly\/1\/","description":"A comprehensive guide to time-series anomaly detection methods, from statistical approaches (moving average \u002b standard deviation) to Kalman filter innovation-based detection, with Python implementations and comparisons.","inLanguage":"en","isPartOf":{"@type":"WebSite","name":"tomato blog","url":"https:\/\/yuhi-sa.github.io\/"}}</script></body></html>